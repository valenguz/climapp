name: ðŸš€ Deploy ClimApp to Minikube

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    # PASO 1: Descargar el cÃ³digo
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    # PASO 2: Configurar Minikube
    - name: âš™ï¸ Setup Minikube
      uses: manusa/actions-setup-minikube@v2
      with:
        minikube version: 'v1.32.0'
        kubernetes version: 'v1.28.0'

    # PASO 3: Desplegar en Kubernetes
    - name: ðŸš€ Deploy to Kubernetes
      run: |
        echo "ðŸŽ¯ Iniciando Minikube..."
        minikube start
        minikube status
        
        echo "ðŸ“ Aplicando configuraciÃ³n Kubernetes..."
        kubectl apply -f kube/
        
        echo "â³ Esperando a que los pods estÃ©n listos..."
        sleep 60
        
        echo "âœ… Despliegue completado"

    # PASO 4: Capturar evidencias (PARA TU TAREA)
    - name: ðŸ“¸ Capture Evidence
      run: |
        echo "=== EVIDENCIAS DEL DESPLIEGUE ===" > evidence.txt
        echo "Fecha: $(date)" >> evidence.txt
        echo "" >> evidence.txt
        
        echo "=== kubectl get pods ===" >> evidence.txt
        kubectl get pods >> evidence.txt
        echo "" >> evidence.txt
        
        echo "=== kubectl get services ===" >> evidence.txt
        kubectl get services >> evidence.txt
        echo "" >> evidence.txt
        
        echo "=== kubectl get deployments ===" >> evidence.txt
        kubectl get deployments >> evidence.txt
        echo "" >> evidence.txt
        
        echo "=== minikube service list ===" >> evidence.txt
        minikube service list >> evidence.txt
        
        echo "ðŸ“„ Evidencias guardadas en evidence.txt"

    # PASO 5: Subir evidencias (PARA ENTREGAR EN TU TAREA)
    - name: ðŸ“Ž Upload Evidence
      uses: actions/upload-artifact@v4
      with:
        name: deployment-evidence
        path: evidence.txt
        retention-days: 30

    # PASO 6: Mostrar resultados
    - name: ðŸ“Š Show Results
      run: |
        echo "ðŸŽ‰ DESPLIEGUE EXITOSO - CLIMAPP"
        echo "================================"
        kubectl get pods,services,deployments
        echo ""
        echo "ðŸ“Š Para acceder a la aplicaciÃ³n:"
        echo "minikube service climapp-frontend-service"