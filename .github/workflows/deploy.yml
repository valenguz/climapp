name: Deploy ClimApp to Minikube

on:
  push:
    branches: [main]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    # PASO 1: Descargar el cÃ³digo
    - name: Checkout code
      uses: actions/checkout@v4

    # PASO 2: Configurar Docker para construir imÃ¡genes
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    # PASO 3: Construir imagen del Backend
    - name: Build Backend Image
      uses: docker/build-push-action@v5
      with:
        context: ./backend
        push: false
        tags: climapp-backend:latest
        cache-from: type=registry,ref=climapp-backend:latest
        cache-to: type=inline

    # PASO 4: Construir imagen del Frontend
    - name: Build Frontend Image
      uses: docker/build-push-action@v5
      with:
        context: ./frontend/climapp
        push: false
        tags: climapp-frontend:latest
        cache-from: type=registry,ref=climapp-frontend:latest
        cache-to: type=inline

  deploy-to-kubernetes:
    needs: build-and-test  # Espera a que termine el job anterior
    runs-on: ubuntu-latest
    
    steps:
    # PASO 5: Descargar cÃ³digo otra vez (cada job es independiente)
    - name: Checkout code
      uses: actions/checkout@v4

    # PASO 6: Instalar Minikube (Kubernetes local)
    - name: Set up Minikube
      uses: manusa/actions-setup-minikube@v2
      with:
        minikube version: 'v1.32.0'
        kubernetes version: 'v1.28.0'

    # PASO 7: Desplegar en Kubernetes
    - name: Deploy to Minikube
      run: |
        # Iniciar Minikube
        minikube start
        echo "âœ… Minikube iniciado"
        
        # Aplicar la configuraciÃ³n de Kubernetes
        kubectl apply -f kube/
        echo "âœ… Archivos YAML aplicados"
        
        # Esperar a que los pods estÃ©n listos
        echo "â³ Esperando a que los pods estÃ©n listos..."
        kubectl wait --for=condition=ready pod -l app=climapp-backend --timeout=180s
        kubectl wait --for=condition=ready pod -l app=climapp-frontend --timeout=180s
        echo "âœ… Todos los pods estÃ¡n listos"

    # PASO 8: Capturar evidencias (requisito de tu tarea)
    - name: Capture deployment evidence
      run: |
        echo "ðŸ“¸ Capturando evidencias del despliegue..."
        
        # Estado de todos los recursos
        kubectl get all > deployment-status.txt
        
        # DescripciÃ³n detallada de pods
        kubectl describe pods > pods-description.txt
        
        # Lista de servicios y sus URLs
        minikube service list > services-list.txt
        
        # Logs de los pods (Ãºltimas 10 lÃ­neas)
        kubectl logs -l app=climapp-backend --tail=10 > backend-logs.txt
        kubectl logs -l app=climapp-frontend --tail=10 > frontend-logs.txt
        
        echo "âœ… Evidencias capturadas"

    # PASO 9: Guardar las evidencias como archivos descargables
    - name: Upload evidence artifacts
      uses: actions/upload-artifact@v4
      with:
        name: deployment-evidence
        path: |
          deployment-status.txt
          pods-description.txt
          services-list.txt
          backend-logs.txt
          frontend-logs.txt
        retention-days: 30

    # PASO 10: Mostrar informaciÃ³n Ãºtil
    - name: Show deployment info
      run: |
        echo "ðŸŽ‰ DESPLIEGUE EXITOSO"
        echo "===================="
        echo "Pods desplegados:"
        kubectl get pods
        echo ""
        echo "Servicios:"
        kubectl get services
        echo ""
        echo "Para acceder a la aplicaciÃ³n ejecuta:"
        echo "minikube service climapp-frontend-service"